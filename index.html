<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meter Sorting System - Stable Version</title>
    <!-- Simplified dependencies for stability -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            margin: 10px 0;
        }
        .upload-area:hover {
            border-color: #165DFF;
        }
        .btn {
            background: #165DFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px 0;
        }
        .btn:hover {
            background: #0e48d8;
        }
        .input-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            margin: 10px 0;
        }
        .alert {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            display: none;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background: #f8f9fa;
        }
        .hidden {
            display: none;
        }
        .debug-panel {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 12px;
            color: #333;
        }
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .result-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #165DFF;
        }
        .result-label {
            font-weight: bold;
            color: #666;
            font-size: 12px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Meter Sorting System (Stable Version)</h1>
        
        <!-- Step 1: Excel Upload -->
        <div class="card">
            <h2>1. Upload Excel File</h2>
            <div class="upload-area" id="uploadArea">
                <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;">
                <p>Click to select Excel file (.xlsx/.xls)</p>
                <button class="btn" onclick="document.getElementById('excelFile').click()">Select File</button>
            </div>
            <div id="uploadAlert" class="alert"></div>
            
            <!-- Debug Panel -->
            <div class="debug-panel">
                <h4>Debug Information:</h4>
                <p id="debugInfo">No file uploaded</p>
            </div>
        </div>

        <!-- Step 2: Search -->
        <div class="card">
            <h2>2. Search Meter Number</h2>
            <input type="text" id="meterInput" class="input-box" placeholder="Enter Meter Number">
            <button class="btn" onclick="searchMeter()">Search Schemes</button>
            <div id="searchAlert" class="alert"></div>
            <div id="resultArea" style="margin-top: 10px; display: none;">
                <h3>Search Result:</h3>
                <div class="result-grid">
                    <div class="result-card">
                        <div class="result-label">Meter Number</div>
                        <div id="resultMeter">-</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Schemes</div>
                        <div id="resultScheme">-</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Customer Name</div>
                        <div id="resultCustomer">-</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Mother Ref</div>
                        <div id="resultMotherRef">-</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Work Order</div>
                        <div id="resultWorkOrder">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Search History -->
        <div class="card">
            <h2>3. Search History</h2>
            <button class="btn" style="background: #dc3545;" onclick="clearHistory()">Clear History</button>
            <button class="btn" style="background: #28a745;" onclick="exportHistory()">Export History</button>
            <div style="overflow-x: auto; margin-top: 10px;">
                <table>
                    <thead>
                        <tr>
                            <th>Serial No.</th>
                            <th>Search Time</th>
                            <th>Meter Number</th>
                            <th>Schemes</th>
                            <th>Customer Name</th>
                            <th>Mother Ref</th>
                            <th>Work Order</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable">
                        <tr>
                            <td colspan="7" style="text-align: center;">No history records</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let excelData = []; // Store Excel data
        let searchHistory = []; // Search history

        // Initialize
        window.onload = function() {
            // Load history records
            loadHistory();
            renderHistory();
            
            // Bind file upload event
            document.getElementById('excelFile').addEventListener('change', handleFileUpload);
            
            // Support drag and drop upload
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#165DFF';
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#ccc';
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ccc';
                if (e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
        };

        // Handle file upload
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // Core: Parse Excel file (simplified version)
        function handleFile(file) {
            // Reset state
            excelData = [];
            showAlert('uploadAlert', 'Reading file: ' + file.name, 'info');
            
            // Check file type
            const ext = file.name.split('.').pop().toLowerCase();
            if (ext !== 'xlsx' && ext !== 'xls') {
                showAlert('uploadAlert', 'Please upload Excel file in .xlsx or .xls format', 'error');
                updateDebug('File type error: ' + ext);
                return;
            }

            // Read file (compatible with all browsers)
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // Core parsing logic (SheetJS simplest usage)
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', raw: true });
                    
                    // Get first sheet
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // Convert to JSON (auto recognize header)
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // Debug information
                    updateDebug(`
                        File Name: ${file.name}
                        File Size: ${(file.size/1024).toFixed(1)}KB
                        Sheet Name: ${sheetName}
                        Data Rows: ${jsonData.length}
                        Column Names: ${jsonData.length > 0 ? Object.keys(jsonData[0]).join(', ') : 'None'}
                    `);

                    // If no data
                    if (jsonData.length === 0) {
                        showAlert('uploadAlert', 'No data found in Excel file', 'error');
                        return;
                    }

                    // Extended column matching logic
                    let fieldKeys = {
                        meter: null,
                        scheme: null,
                        customer: null,
                        motherRef: null,
                        workOrder: null
                    };

                    // Column name keywords for matching
                    const fieldKeywords = {
                        meter: ['meter', 'meter number', 'meternumber', 'meterid', 'meter_no'],
                        scheme: ['scheme', 'schemes', 'plan', 'program'],
                        customer: ['customer', 'customer name', 'customername', 'client', 'client name'],
                        motherRef: ['mother ref', 'motherref', 'mother_reference', 'motherid'],
                        workOrder: ['work order', 'workorder', 'work_order', 'wo', 'orderid']
                    };

                    // Iterate through all keys in first row to find matches
                    const firstRowKeys = Object.keys(jsonData[0]);
                    for (const key of firstRowKeys) {
                        const lowerKey = key.toLowerCase().replace(/\s+/g, '');
                        
                        // Match each field
                        Object.keys(fieldKeywords).forEach(field => {
                            if (!fieldKeys[field]) {
                                fieldKeywords[field].forEach(keyword => {
                                    if (lowerKey.includes(keyword.replace(/\s+/g, ''))) {
                                        fieldKeys[field] = key;
                                    }
                                });
                            }
                        });
                    }

                    // Check required fields (Meter Number is mandatory)
                    if (!fieldKeys.meter) {
                        showAlert('uploadAlert', `Meter Number column not found! Current columns: ${firstRowKeys.join(', ')}`, 'error');
                        return;
                    }

                    // Extract valid data with extended fields
                    excelData = jsonData.map(row => ({
                        meter: row[fieldKeys.meter] ? String(row[fieldKeys.meter]).trim() : '',
                        scheme: fieldKeys.scheme ? (row[fieldKeys.scheme] ? String(row[fieldKeys.scheme]).trim() : '') : '',
                        customer: fieldKeys.customer ? (row[fieldKeys.customer] ? String(row[fieldKeys.customer]).trim() : '') : '',
                        motherRef: fieldKeys.motherRef ? (row[fieldKeys.motherRef] ? String(row[fieldKeys.motherRef]).trim() : '') : '',
                        workOrder: fieldKeys.workOrder ? (row[fieldKeys.workOrder] ? String(row[fieldKeys.workOrder]).trim() : '') : ''
                    })).filter(row => row.meter); // Filter empty meter numbers

                    // Show success message with field recognition status
                    const recognizedFields = [];
                    if (fieldKeys.meter) recognizedFields.push('Meter Number');
                    if (fieldKeys.scheme) recognizedFields.push('Schemes');
                    if (fieldKeys.customer) recognizedFields.push('Customer Name');
                    if (fieldKeys.motherRef) recognizedFields.push('Mother Ref');
                    if (fieldKeys.workOrder) recognizedFields.push('Work Order');

                    showAlert('uploadAlert', `Upload successful! Parsed ${excelData.length} valid records. Recognized fields: ${recognizedFields.join(', ')}`, 'success');
                    
                } catch (error) {
                    showAlert('uploadAlert', 'Parsing failed: ' + error.message, 'error');
                    updateDebug('Parsing error: ' + error.stack);
                }
            };

            reader.onerror = function() {
                showAlert('uploadAlert', 'File reading failed, please check if the file is corrupted', 'error');
                updateDebug('File reading error: ' + reader.error);
            };

            // Read file (key: use readAsArrayBuffer)
            reader.readAsArrayBuffer(file);
        }

        // Search meter number
        function searchMeter() {
            const meterInput = document.getElementById('meterInput').value.trim();
            if (!meterInput) {
                showAlert('searchAlert', 'Please enter Meter Number', 'error');
                return;
            }
            if (excelData.length === 0) {
                showAlert('searchAlert', 'Please upload Excel file first', 'error');
                return;
            }

            // Fuzzy search (case insensitive)
            const lowerInput = meterInput.toLowerCase();
            const result = excelData.find(item => 
                item.meter.toLowerCase().includes(lowerInput)
            );

            // Show result
            const resultArea = document.getElementById('resultArea');
            resultArea.style.display = 'block';
            
            if (result) {
                // Populate all fields in result
                document.getElementById('resultMeter').textContent = result.meter || '-';
                document.getElementById('resultScheme').textContent = result.scheme || '-';
                document.getElementById('resultCustomer').textContent = result.customer || '-';
                document.getElementById('resultMotherRef').textContent = result.motherRef || '-';
                document.getElementById('resultWorkOrder').textContent = result.workOrder || '-';
                
                showAlert('searchAlert', 'Search successful', 'success');
                
                // Add to history
                addToHistory(result);
            } else {
                // Clear result fields when not found
                document.getElementById('resultMeter').textContent = meterInput;
                document.getElementById('resultScheme').textContent = 'Not found';
                document.getElementById('resultCustomer').textContent = 'Not found';
                document.getElementById('resultMotherRef').textContent = 'Not found';
                document.getElementById('resultWorkOrder').textContent = 'Not found';
                
                showAlert('searchAlert', 'Meter Number not found', 'error');
                
                // Add to history (not found)
                addToHistory({
                    meter: meterInput,
                    scheme: 'Not found',
                    customer: 'Not found',
                    motherRef: 'Not found',
                    workOrder: 'Not found'
                });
            }
        }

        // Add to history records
        function addToHistory(data) {
            const now = new Date();
            const timeStr = now.toLocaleString('en-US');
            
            searchHistory.push({
                time: timeStr,
                meter: data.meter,
                scheme: data.scheme,
                customer: data.customer,
                motherRef: data.motherRef,
                workOrder: data.workOrder
            });
            
            // Save to local storage
            localStorage.setItem('meterSearchHistory', JSON.stringify(searchHistory));
            // Render history
            renderHistory();
        }

        // Load history records
        function loadHistory() {
            const historyStr = localStorage.getItem('meterSearchHistory');
            if (historyStr) {
                searchHistory = JSON.parse(historyStr);
            }
        }

        // Render history records table
        function renderHistory() {
            const tableBody = document.getElementById('historyTable');
            
            if (searchHistory.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No history records</td></tr>';
                return;
            }

            let html = '';
            searchHistory.forEach((item, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.time}</td>
                        <td>${item.meter}</td>
                        <td>${item.scheme || '-'}</td>
                        <td>${item.customer || '-'}</td>
                        <td>${item.motherRef || '-'}</td>
                        <td>${item.workOrder || '-'}</td>
                    </tr>
                `;
            });
            tableBody.innerHTML = html;
        }

        // Clear history records
        function clearHistory() {
            if (confirm('Are you sure to clear all history records?')) {
                searchHistory = [];
                localStorage.removeItem('meterSearchHistory');
                renderHistory();
                showAlert('searchAlert', 'History records cleared successfully', 'success');
            }
        }

        // Export history records to Excel
        function exportHistory() {
            if (searchHistory.length === 0) {
                showAlert('searchAlert', 'No history records to export', 'error');
                return;
            }

            // Prepare export data
            const exportData = searchHistory.map((item, index) => ({
                'Serial No.': index + 1,
                'Search Time': item.time,
                'Meter Number': item.meter,
                'Schemes': item.scheme || '-',
                'Customer Name': item.customer || '-',
                'Mother Ref': item.motherRef || '-',
                'Work Order': item.workOrder || '-'
            }));

            // Create Excel
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Search History');
            
            // Adjust column width for better readability
            const wscols = [
                {wch: 10},  // Serial No.
                {wch: 25},  // Search Time
                {wch: 20},  // Meter Number
                {wch: 15},  // Schemes
                {wch: 25},  // Customer Name
                {wch: 20},  // Mother Ref
                {wch: 20}   // Work Order
            ];
            worksheet['!cols'] = wscols;
            
            // Download file
            const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            XLSX.writeFile(workbook, `Meter_Search_History_${dateStr}.xlsx`);
            showAlert('searchAlert', 'History records exported successfully', 'success');
        }

        // Show alert message
        function showAlert(id, message, type) {
            const alertEl = document.getElementById(id);
            alertEl.textContent = message;
            alertEl.style.display = 'block';
            
            // Set style
            if (type === 'success') {
                alertEl.className = 'alert alert-success';
            } else if (type === 'error') {
                alertEl.className = 'alert alert-error';
            } else {
                alertEl.className = 'alert alert-info';
            }

            // Hide after 3 seconds
            setTimeout(() => {
                alertEl.style.display = 'none';
            }, 3000);
        }

        // Update debug information
        function updateDebug(info) {
            document.getElementById('debugInfo').textContent = info.replace(/\n/g, ' ');
        }
    </script>
</body>
</html>
